<!DOCTYPE html>
<html>
<head>
  <title>Drug Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdf9ff;
      color: #2e003e;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h2 {
      color: #5a189a;
    }
    .details-section {
      background: #f3e8ff;
      padding: 15px;
      border-left: 4px solid #9d4edd;
      margin-top: 20px;
    }
    .error {
      color: #b30000;
      font-weight: bold;
    }
    .loading {
      color: #5a189a;
    }
    a {
      color: #5a189a;
    }
  </style>
</head>
<body>
  <h2>Drug Detailed Information</h2>
  <div id="info" class="details-section loading">Loading...</div>
  <div style="margin-top:1em;">
    <a href="index.html">&larr; Back to Drug Lookup</a>
  </div>
<script>
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // Try via RxCUI, then NDC, then Set ID.
  async function loadDetails() {
    const infoDiv = document.getElementById("info");
    // Try to get all possible params
    const rxcui = getQueryParam("rxcui");
    let ndc = getQueryParam("ndc");
    let setid = getQueryParam("setid");

    infoDiv.innerHTML = 'Loading...';

    // Try 1: RxCUI → SPL_SET_ID → DailyMed
    if (rxcui) {
      infoDiv.innerHTML = 'Looking up SPL Set ID from RxNorm (via RxCUI)...';
      try {
        const rxRes = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/allProperties.json?prop=all`);
        const rxJson = await rxRes.json();
        const props = rxJson?.propConceptGroup?.propConcept || [];
        const spl = props.find(p => p.propName === "SPL_SET_ID");
        if (spl?.propValue) {
          setid = spl.propValue;
          // Proceed to DailyMed with setid
          return fetchAndRenderDailyMed(infoDiv, { setid, rxcui });
        }
      } catch (err) {
        // continue to next method
      }
      infoDiv.innerHTML += "<br>Could not retrieve SPL Set ID via RxCUI.";
    }

    // Try 2: NDC → DailyMed
    if (ndc) {
      infoDiv.innerHTML += '<br>Trying DailyMed with NDC...';
      // NDC must be in 10 or 11 digit format, strip dashes
      let ndcClean = ndc.replace(/[^0-9]/g, "");
      // If 10 digits, try direct, if 11 digits, also try direct
      try {
        let ndcUrl = `https://dailymed.nlm.nih.gov/dailymed/services/v2/ndc/${ndcClean}.json`;
        let ndcRes = await fetch(ndcUrl);
        if (ndcRes.ok) {
          let ndcJson = await ndcRes.json();
          // Try to extract setid from returned data
          let spls = ndcJson.data?.spls;
          if (spls && spls.length > 0 && spls[0].setid) {
            setid = spls[0].setid;
            return fetchAndRenderDailyMed(infoDiv, { setid, ndc });
          }
        }
      } catch (err) {
        // continue to next method
      }
      infoDiv.innerHTML += "<br>Could not retrieve SPL Set ID via NDC.";
    }

    // Try 3: Direct Set ID (from query param)
    if (setid) {
      infoDiv.innerHTML += '<br>Trying DailyMed with Set ID...';
      return fetchAndRenderDailyMed(infoDiv, { setid });
    }

    // No methods worked
    infoDiv.innerHTML += `<br><span class="error">Unable to retrieve drug details.<br>
      No valid RxCUI, NDC, or SPL Set ID found/provided or matched a DailyMed record.</span>`;
  }

  // Helper: fetch & display info from DailyMed using Set ID
  async function fetchAndRenderDailyMed(infoDiv, { setid, rxcui, ndc }) {
    infoDiv.innerHTML = 'Fetching details from DailyMed...';
    try {
      const dailyMedRes = await fetch(`https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/${setid}.json`);
      if (!dailyMedRes.ok) throw new Error('DailyMed returned non-OK status');
      const dailyMedJson = await dailyMedRes.json();

      // Basic summary rendering
      const setInfo = dailyMedJson.data?.spls?.[0];
      if (!setInfo) throw new Error('No SPL data found');

      infoDiv.innerHTML = `
        <b>${setInfo.title || "No Title"}</b><br>
        <b>Set ID:</b> ${setid}<br>
        ${rxcui ? `<b>RxCUI:</b> ${rxcui}<br>` : ""}
        ${ndc ? `<b>NDC:</b> ${ndc}<br>` : ""}
        <b>Published Date:</b> ${setInfo.publishedDate ? new Date(setInfo.publishedDate).toLocaleDateString() : 'N/A'}<br>
        <br>
        <b>Products:</b><br>
        <ul>
          ${(setInfo.products || []).map(prod =>
            `<li>${prod.name || prod.ndc} (${prod.ndc || "No NDC"})</li>`
          ).join('')}
        </ul>
        <br>
        <b>Full Label:</b>
        <a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${setid}" target="_blank">View on DailyMed</a>
        <br><br>
        <b>Sources:</b>
        <ul>
          ${rxcui ? `<li><a href="https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${encodeURIComponent(rxcui)}" target="_blank">RxNav Record</a></li>` : ""}
          <li><a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${setid}" target="_blank">DailyMed Entry</a></li>
        </ul>
      `;
    } catch (e) {
      infoDiv.innerHTML = `
        <span class="error">Failed to fetch details from DailyMed.<br>
        <small>${e.message}</small>
        </span>
        <br>
        <a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${setid}" target="_blank">Try viewing on DailyMed</a>
      `;
    }
  }

  window.onload = loadDetails;
</script>
</body>
</html>
