<!DOCTYPE html>
<html>
<head>
  <title>Drug Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdf9ff;
      color: #2e003e;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h2 {
      color: #5a189a;
    }
    .details-section {
      background: #f3e8ff;
      padding: 15px;
      border-left: 4px solid #9d4edd;
      margin-top: 20px;
    }
    .error {
      color: #b30000;
      font-weight: bold;
    }
    .loading {
      color: #5a189a;
    }
    a {
      color: #5a189a;
    }
  </style>
</head>
<body>
  <h2>Drug Detailed Information</h2>
  <div id="info" class="details-section loading">Loading...</div>
  <div style="margin-top:1em;">
    <a href="index.html">&larr; Back to Drug Lookup</a>
  </div>
<script>
  // Util: Get query param from URL
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }
  // Util: Format NDC to dashed style (#####-####-##)
  function formatNdcDashed(ndc) {
    ndc = ndc.replace(/[^0-9]/g, '').padStart(11, '0');
    return ndc.slice(0, 5) + '-' + ndc.slice(5, 9) + '-' + ndc.slice(9);
  }
  // Manual links fallback
  function manualLinks({ setid, ndc, rxcui }) {
    let links = [];
    if (setid) links.push(`<a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${setid}" target="_blank">View on DailyMed (by Set ID)</a>`);
    if (ndc) links.push(`<a href="https://dailymed.nlm.nih.gov/dailymed/search.cfm?query=${ndc}" target="_blank">Search DailyMed (by NDC)</a>`);
    if (rxcui) links.push(`<a href="https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${encodeURIComponent(rxcui)}" target="_blank">View in RxNav (by RxCUI)</a>`);
    return links.length ? `<br><br><b>Manual Links:</b><br>${links.join('<br>')}` : '';
  }
  // Try to fetch and render from DailyMed SPL Set ID
  async function fetchAndRenderDailyMed(infoDiv, { setid, ndc, rxcui }) {
    try {
      const dailyMedRes = await fetch(`https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/${setid}.json`);
      if (!dailyMedRes.ok) throw new Error('DailyMed returned non-OK status');
      const dailyMedJson = await dailyMedRes.json();
      const setInfo = dailyMedJson.data?.spls?.[0];
      if (!setInfo) throw new Error('No SPL data found');
      infoDiv.innerHTML = `
        <b>${setInfo.title || "No Title"}</b><br>
        <b>Set ID:</b> ${setid}<br>
        ${rxcui ? `<b>RxCUI:</b> ${rxcui}<br>` : ""}
        ${ndc ? `<b>NDC:</b> ${ndc}<br>` : ""}
        <b>Published Date:</b> ${setInfo.publishedDate ? new Date(setInfo.publishedDate).toLocaleDateString() : 'N/A'}<br>
        <br>
        <b>Products:</b><br>
        <ul>
          ${(setInfo.products || []).map(prod =>
            `<li>${prod.name || prod.ndc} (${prod.ndc || "No NDC"})</li>`
          ).join('')}
        </ul>
        <br>
        <b>Full Label:</b>
        <a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${setid}" target="_blank">View on DailyMed</a>
        ${manualLinks({ setid, ndc, rxcui })}
      `;
      return true;
    } catch (e) {
      return false;
    }
  }
  // Fetch Set ID given an NDC (using v1, dashed)
  async function getSetIdFromNdc(ndc) {
    const dashedNdc = formatNdcDashed(ndc);
    const url = `https://dailymed.nlm.nih.gov/dailymed/services/v1/ndc/${dashedNdc}/spls.json`;
    try {
      const res = await fetch(url);
      if (!res.ok) return null;
      const arr = await res.json();
      return arr.length > 0 ? arr[0] : null; // First Set ID
    } catch (e) {
      return null;
    }
  }
  // Fetch Set ID given RxCUI (via RxNorm)
  async function getSetIdFromRxcui(rxcui) {
    try {
      const rxRes = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/allProperties.json?prop=all`);
      const rxJson = await rxRes.json();
      const props = rxJson?.propConceptGroup?.propConcept || [];
      const spl = props.find(p => p.propName === "SPL_SET_ID");
      return spl?.propValue || null;
    } catch (e) {
      return null;
    }
  }
  // Main loader: Most reliable method first, always manual fallback
  async function loadDetails() {
    const infoDiv = document.getElementById("info");
    let setid = getQueryParam("setid");
    let ndc = getQueryParam("ndc");
    let rxcui = getQueryParam("rxcui");
    // 1. Set ID direct
    if (setid) {
      infoDiv.innerHTML = `Fetching details from DailyMed using Set ID...`;
      if (await fetchAndRenderDailyMed(infoDiv, { setid, ndc, rxcui })) return;
      infoDiv.innerHTML += `<br><span class="error">Failed to fetch details via API.</span>${manualLinks({ setid, ndc, rxcui })}`;
      return;
    }
    // 2. NDC via v1 endpoint (dashed)
    if (ndc) {
      infoDiv.innerHTML = `Looking up SPL Set ID from DailyMed (v1) using NDC...`;
      setid = await getSetIdFromNdc(ndc);
      if (setid) {
        if (await fetchAndRenderDailyMed(infoDiv, { setid, ndc, rxcui })) return;
      }
      infoDiv.innerHTML += `<br><span class="error">Failed to fetch details via API.</span>${manualLinks({ setid, ndc, rxcui })}`;
      return;
    }
    // 3. RxCUI via RxNorm to Set ID
    if (rxcui) {
      infoDiv.innerHTML = `Looking up SPL Set ID from RxNorm using RxCUI...`;
      setid = await getSetIdFromRxcui(rxcui);
      if (setid) {
        if (await fetchAndRenderDailyMed(infoDiv, { setid, ndc, rxcui })) return;
      }
      infoDiv.innerHTML += `<br><span class="error">Failed to fetch details via API.</span>${manualLinks({ setid, ndc, rxcui })}`;
      return;
    }
    // 4. No identifiers at all
    infoDiv.innerHTML = `<span class="error">No RxCUI, NDC, or Set ID provided in URL!</span>`;
  }
  window.onload = loadDetails;
</script>
</body>
</html>
