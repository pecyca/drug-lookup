<!DOCTYPE html>
<html>
<head>
  <title>Drug Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdf9ff;
      color: #2e003e;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h2 {
      color: #5a189a;
    }
    .details-section {
      background: #f3e8ff;
      padding: 15px;
      border-left: 4px solid #9d4edd;
      margin-top: 20px;
    }
    .error {
      color: #b30000;
      font-weight: bold;
    }
    .loading {
      color: #5a189a;
    }
    a {
      color: #5a189a;
    }
  </style>
</head>
<body>
  <h2>Drug Detailed Information</h2>
  <div id="info" class="details-section loading">Loading...</div>
  <div style="margin-top:1em;">
    <a href="index.html">&larr; Back to Drug Lookup</a>
  </div>

<script>
  // Helper to get query param
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // Main details loader
  async function loadDetails() {
    const infoDiv = document.getElementById("info");
    const rxcui = getQueryParam("rxcui");
    if (!rxcui) {
      infoDiv.innerHTML = '<span class="error">No RxCUI provided in URL.</span>';
      return;
    }
    infoDiv.innerHTML = 'Looking up SPL Set ID from RxNorm...';

    // 1. Get SPL_SET_ID from RxNorm
    let splSetId = null;
    try {
      const rxRes = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/allProperties.json?prop=all`);
      const rxJson = await rxRes.json();
      const props = rxJson?.propConceptGroup?.propConcept || [];
      const spl = props.find(p => p.propName === "SPL_SET_ID");
      if (spl) splSetId = spl.propValue;
    } catch (err) {
      // ignore, error handled below
    }

    if (!splSetId) {
      infoDiv.innerHTML = `
        <span class="error">Failed to retrieve SPL Set ID for this RxCUI.<br>
        This drug may not have a DailyMed record linked to this RxCUI.<br>
        <br>
        <a href="https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${encodeURIComponent(rxcui)}" target="_blank">View in RxNav</a>
        </span>
      `;
      return;
    }

    // 2. Fetch details from DailyMed using SPL_SET_ID
    infoDiv.innerHTML = 'Fetching details from DailyMed...';
    try {
      const dailyMedRes = await fetch(`https://dailymed.nlm.nih.gov/dailymed/services/v2/spls/${splSetId}.json`);
      if (!dailyMedRes.ok) throw new Error('DailyMed returned non-OK status');
      const dailyMedJson = await dailyMedRes.json();

      // Basic summary rendering
      const setInfo = dailyMedJson.data?.spls?.[0];
      if (!setInfo) throw new Error('No SPL data found');

      infoDiv.innerHTML = `
        <b>${setInfo.title || "No Title"}</b><br>
        <b>Set ID:</b> ${splSetId}<br>
        <b>RxCUI:</b> ${rxcui}<br>
        <b>Published Date:</b> ${setInfo.publishedDate ? new Date(setInfo.publishedDate).toLocaleDateString() : 'N/A'}<br>
        <br>
        <b>Products:</b><br>
        <ul>
          ${(setInfo.products || []).map(prod =>
            `<li>${prod.name || prod.ndc} (${prod.ndc || "No NDC"})</li>`
          ).join('')}
        </ul>
        <br>
        <b>Full Label:</b>
        <a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${splSetId}" target="_blank">View on DailyMed</a>
        <br><br>
        <b>Sources:</b>
        <ul>
          <li><a href="https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${encodeURIComponent(rxcui)}" target="_blank">RxNav Record</a></li>
          <li><a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${splSetId}" target="_blank">DailyMed Entry</a></li>
        </ul>
      `;
    } catch (e) {
      infoDiv.innerHTML = `
        <span class="error">Failed to fetch details from DailyMed.<br>
        <small>${e.message}</small>
        </span>
        <br>
        <a href="https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${splSetId}" target="_blank">Try viewing on DailyMed</a>
      `;
    }
  }

  window.onload = loadDetails;
</script>
</body>
</html>
