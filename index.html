<!DOCTYPE html>
<html><head>
  <title>NDC Comparison & Drug Lookup</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #fdf9ff; color: #2e003e;
           padding: 20px; max-width: 700px; margin: auto; }
    h2 { color: #4b007d; }
    input, button {
      padding: 10px; margin: 5px 0; width: 100%;
      border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
    }
    button {
      background-color: #6a1b9a; color: white; font-weight: bold;
      border: none; cursor: pointer; transition: background-color 0.2s;
    }
    button:hover { background-color: #4b007d; }
    pre, #result {
      background: #f2f2f2; padding: 15px; border-left: 4px solid #ccc;
      margin-top: 10px; white-space: pre-wrap;
    }
    .note { font-size: 0.9em; color: #444; margin-bottom: 15px; }
    .disclaimer {
      margin-top: 40px; font-size: 0.85em; color: #666;
      border-top: 1px solid #ccc; padding-top: 15px;
    }
  </style>
</head><body>

<h2>NDC Comparison & Drug Lookup</h2>
<div class="note">
  Enter one or two NDCs to look up drug info or compare.<br>
  <strong>Box 2 is optional.</strong>
</div>

<label>Box 1 (NDC):</label><input id="ndc1" />
<label>Box 2 (optional NDC):</label><input id="ndc2" />

<button onclick="compareNDCs()">Compare / Look Up</button>
<h3>Result:</h3>
<pre id="result">Results will appear here...</pre>

<div class="disclaimer">
  <strong>Disclaimer:</strong> This is beta‚ÄîAPIs may not be fully accurate. Always verify clinically.
</div>

<script>
  function normalizeNdc(o){return o.replace(/\D/g,'').padStart(11,'0');}
  function prettyNdc(o){return o.slice(0,5)+'-'+o.slice(5,9)+'-'+o.slice(9);}
  
  async function getRxcuiFromNdc(n){
    let f = prettyNdc(n);
    let j = await fetch(`https://rxnav.nlm.nih.gov/REST/ndcproperties.json?id=${f}&idtype=NDC`).then(r=>r.json());
    let i = j.ndcPropertyList?.ndcProperty?.[0];
    return {rxcui: i?.rxcui||null, ndcRaw: n, ndcPretty: f};
  }

  async function getBrandName(rxcui){
    let j = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/related.json?tty=BN`)
      .then(r=>r.json());
    return j.relatedGroup?.conceptGroup?.[0]?.conceptProperties?.[0]?.name||"Unknown";
  }
  async function getFormName(rxcui){
    let j = await fetch(`https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/properties.json`)
      .then(r=>r.json());
    return j.properties?.name||"Unknown";
  }

  // **NEW**: DailyMed SPL using v1 endpoint with raw NDC
  async function getSetId(ndcRaw){
    let j = await fetch(`https://dailymed.nlm.nih.gov/dailymed/services/v1/ndc/${ndcRaw}/spls.json`)
      .then(r=>r.ok? r.json(): {});
    return j.spls?.[0]?.setid || null;
  }

  function lexLink(n){ return `https://online.lexi.com/lco/action/search?q=${n}&t=name`; }

  async function compareNDCs(){
    let r1 = document.getElementById('ndc1').value.trim();
    let r2 = document.getElementById('ndc2').value.trim();
    let resEl = document.getElementById('result');
    if (!r1){ resEl.innerHTML='Enter at least NDC 1.'; return; }
    resEl.innerHTML='Loading‚Ä¶';

    let n1 = normalizeNdc(r1), n2 = normalizeNdc(r2);
    let o1 = await getRxcuiFromNdc(n1), o2 = r2? await getRxcuiFromNdc(n2): null;
    if (!o1.rxcui){ resEl.innerHTML='NDC 1 not found.'; return; }

    let b1 = await getBrandName(o1.rxcui), f1 = await getFormName(o1.rxcui);
    let set1 = await getSetId(n1);

    let html = `<b>üßæ NDC Lookup</b><br><br>
Brand: ${b1}<br>
Form: ${f1}<br>
RxCUI: ${o1.rxcui}<br><br>
<a href="${lexLink(o1.ndcPretty)}" target="_blank">View on Lexicomp</a><br>
<a href="details.html?ndc=${n1}" target="_blank">Detailed Info</a><br>` +
(set1? `<a href="details.html?ndc=${n1}" target="_blank">More Info (DailyMed)</a><br>`:'');
    
    if (r2){
      if (!o2.rxcui){ html = 'NDC 2 not found.'; }
      else {
        let b2 = await getBrandName(o2.rxcui), f2 = await getFormName(o2.rxcui);
        let set2 = await getSetId(n2);
        let status = o1.rxcui===o2.rxcui
          ? '‚úîÔ∏è <b>Equivalent RxCUI</b>' 
          : '‚ö†Ô∏è <b>Different RxCUI</b> ‚Äî may still be clinically equivalent';
        html = `${status}<br><br>
<b>NDC 1:</b> ${b1}, ${f1}, RxCUI <a href="https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${o1.rxcui}" target="_blank">${o1.rxcui}</a><br>
<a href="${lexLink(o1.ndcPretty)}" target="_blank">Lexicomp</a><br>` +
(set1? `<a href="details.html?ndc=${n1}" target="_blank">DailyMed</a><br>`:'') + `<br>
<b>NDC 2:</b> ${b2}, ${f2}, RxCUI <a href="https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${o2.rxcui}" target="_blank">${o2.rxcui}</a><br>
<a href="${lexLink(o2.ndcPretty)}" target="_blank">Lexicomp</a><br>` +
(set2? `<a href="details.html?ndc=${n2}" target="_blank">DailyMed</a><br>`:'') + 
`<br><i>Note: Mismatched RxCUI doesn‚Äôt always mean clinically different.</i>`;
      }
    }

    resEl.innerHTML = html;
  }

  window.onerror = (msg, src, line) => {
    document.getElementById('result').innerHTML = `JS error: ${msg} (line ${line})`;
  };
</script>

</body></html>
