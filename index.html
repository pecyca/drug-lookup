<!DOCTYPE html>
<html>
<head>
  <title>NDC Comparison & Drug Lookup</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #fdf9ff; color: #2e003e; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; }
    button { cursor: pointer; }
    pre, #result {
      background: #f2f2f2;
      padding: 15px;
      white-space: pre-wrap;
      border-left: 4px solid #ccc;
      margin-top: 10px;
    }
    .disclaimer { margin-top: 40px; font-size: 0.85em; color: #666; border-top: 1px solid #ccc; padding-top: 15px; }
    .note { font-size: 0.9em; color: #444; margin-bottom: 15px; }
  </style>
</head>
<body>
  <h2>NDC Comparison & Drug Lookup</h2>

  <div class="note">
    Enter one or two NDCs to look up drug information or compare equivalency.<br>
    <strong>NDC 2 is optional.</strong> If only one NDC is entered, this will function as a lookup tool.
  </div>

  <label for="ndc1">Enter NDC 1:</label>
  <input type="text" id="ndc1" />

  <label for="ndc2">Enter NDC 2 (optional):</label>
  <input type="text" id="ndc2" />

  <button onclick="compareNDCs()">Compare or Lookup</button>

  <h3>Result:</h3>
  <pre id="result">Results will appear here...</pre>

  <div class="disclaimer">
    <strong>Disclaimer:</strong> This tool is in <em>beta</em> and intended for informational purposes only.
    Data is sourced from public APIs and may not reflect the most current or complete information.
  </div>

<script>
  function formatNdc(ndc) {
    ndc = ndc.padStart(11, '0');
    return ndc.slice(0, 5) + '-' + ndc.slice(5, 9) + '-' + ndc.slice(9, 11);
  }

  async function getRxcuiFromNdc(ndc) {
    const formatted = formatNdc(ndc);
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/ndcproperties.json?id=" + formatted + "&idtype=NDC");
    const json = await res.json();
    const item = json?.ndcPropertyList?.ndcProperty?.[0];
    return { rxcui: item?.rxcui || null, formattedNdc: formatted };
  }

  async function getBrandName(rxcui) {
    try {
      const res = await fetch("https://rxnav.nlm.nih.gov/REST/rxcui/" + rxcui + "/related.json?tty=BN");
      const json = await res.json();
      const props = json?.relatedGroup?.conceptGroup?.[0]?.conceptProperties;
      return props?.[0]?.name || "Unknown";
    } catch (e) {
      return "Unknown";
    }
  }

  async function getFormName(rxcui) {
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/rxcui/" + rxcui + "/properties.json");
    const json = await res.json();
    return json?.properties?.name || "Unknown";
  }

  async function getSetIdFromNdc(ndc) {
    const res = await fetch(`https://dailymed.nlm.nih.gov/dailymed/services/v2/spls.json?ndc=${ndc}`);
    const json = await res.json();
    return json?.data?.spls?.[0]?.setid || null;
  }

  async function compareNDCs() {
    const ndc1 = document.getElementById("ndc1").value.trim();
    const ndc2 = document.getElementById("ndc2").value.trim();
    const output = document.getElementById("result");
    output.innerHTML = "Loading...";

    if (!ndc1 && !ndc2) {
      output.innerHTML = "Please enter at least one NDC.";
      return;
    }

    try {
      if (ndc1 && !ndc2) {
        const { rxcui, formattedNdc } = await getRxcuiFromNdc(ndc1);
        if (!rxcui) {
          output.innerHTML = "NDC not found.";
          return;
        }
        const [brand1, form1, setid] = await Promise.all([
          getBrandName(rxcui),
          getFormName(rxcui),
          getSetIdFromNdc(formattedNdc)
        ]);

        let moreInfo = "";
        if (setid) {
          moreInfo = `<a href='https://pecyca.github.io/drug-lookup/details.html?ndc=${formattedNdc}' target='_blank'>More Info (DailyMed)</a><br>`;
        }

        output.innerHTML =
          "<b>üßæ Drug Information (NDC 1)</b><br><br>" +
          "Brand: " + brand1 + "<br>" +
          "Form: " + form1 + "<br>" +
          "RxCUI: " + rxcui + "<br><br>" +
          "<a href='https://online.lexi.com/lco/action/search?q=" + formattedNdc + "&t=name' target='_blank'>View on Lexicomp</a><br>" +
          "<a href='https://pecyca.github.io/drug-lookup/details.html?rxcui=" + rxcui + "' target='_blank'>Detailed Info</a><br>" +
          moreInfo;
        return;
      }

      const [res1, res2] = await Promise.all([
        getRxcuiFromNdc(ndc1),
        getRxcuiFromNdc(ndc2)
      ]);

      const rxcui1 = res1.rxcui;
      const rxcui2 = res2.rxcui;
      const formatted1 = res1.formattedNdc;
      const formatted2 = res2.formattedNdc;

      if (!rxcui1 || !rxcui2) {
        output.innerHTML = "One or both NDCs not found.";
        return;
      }

      const [brand1, form1, brand2, form2, setid1, setid2] = await Promise.all([
        getBrandName(rxcui1),
        getFormName(rxcui1),
        getBrandName(rxcui2),
        getFormName(rxcui2),
        getSetIdFromNdc(formatted1),
        getSetIdFromNdc(formatted2)
      ]);

      const sameRxcui = rxcui1 === rxcui2;
      const status = sameRxcui
        ? "‚úîÔ∏è <b>Equivalent RxCUI</b>"
        : "‚ö†Ô∏è <b>Different RxCUI</b> ‚Äî may still be clinically equivalent";

      output.innerHTML =
        status + "<br><br>" +
        "<b>NDC 1:</b><br>" +
        "Brand: " + brand1 + "<br>" +
        "Form: " + form1 + "<br>" +
        "RxCUI: " + rxcui1 + "<br>" +
        `<a href='https://online.lexi.com/lco/action/search?q=${formatted1}&t=name' target='_blank'>View on Lexicomp</a><br>` +
        `<a href='https://pecyca.github.io/drug-lookup/details.html?rxcui=${rxcui1}' target='_blank'>Detailed Info (NDC 1)</a><br>` +
        (setid1 ? `<a href='https://pecyca.github.io/drug-lookup/details.html?ndc=${formatted1}' target='_blank'>More Info (DailyMed NDC 1)</a><br><br>` : "<br><br>") +
        "<b>NDC 2:</b><br>" +
        "Brand: " + brand2 + "<br>" +
        "Form: " + form2 + "<br>" +
        "RxCUI: " + rxcui2 + "<br>" +
        `<a href='https://online.lexi.com/lco/action/search?q=${formatted2}&t=name' target='_blank'>View on Lexicomp</a><br>` +
        `<a href='https://pecyca.github.io/drug-lookup/details.html?rxcui=${rxcui2}' target='_blank'>Detailed Info (NDC 2)</a><br>` +
        (setid2 ? `<a href='https://pecyca.github.io/drug-lookup/details.html?ndc=${formatted2}' target='_blank'>More Info (DailyMed NDC 2)</a><br><br>` : "<br><br>") +
        "üîç <i>Note: Two drugs may be clinically equivalent even if RxCUIs differ (e.g., different release forms or packages). Use judgment + references.</i>";
    } catch (err) {
      output.innerHTML = "‚ö†Ô∏è Error: " + err.message;
    }
  }

  window.onerror = function (msg, src, line, col, err) {
    const output = document.getElementById("result");
    if (output) {
      output.innerHTML = "JavaScript Error: " + msg + " at line " + line;
    }
  };
</script>

</body>
</html>
