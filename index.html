<!DOCTYPE html>
<html>
<head>
  <title>Drug Info & NDC Comparison</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdf9ff;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      color: #2e003e;
    }
    h2, h3 {
      color: #5a189a;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background-color: #7209b7;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #560bad;
    }
    .result-section {
      background: #f3e8ff;
      padding: 15px;
      margin-top: 10px;
      border-left: 4px solid #9d4edd;
    }
    .child-result {
      margin-left: 20px;
    }
    .ndc-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .ndc-table th, .ndc-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .ndc-table th {
      background-color: #e0caff;
      color: #2e003e;
    }
    .disclaimer {
      margin-top: 40px;
      font-size: 0.85em;
      color: #666;
      border-top: 1px solid #ccc;
      padding-top: 15px;
    }
    .note {
      font-size: 0.9em;
      color: #444;
      margin-bottom: 15px;
    }
    a {
      color: #5a189a;
    }
  </style>
</head>
<body>
  <h2>Drug Info & NDC Comparison</h2>

  <div class="note">
    Enter an <strong>NDC</strong> or <strong>Drug Name</strong> into Box 1 to look up drug information.<br>
    Optionally, enter a second NDC into Box 2 to compare for equivalence.<br>
    <strong>Box 2 is optional.</strong>
  </div>

  <label for="ndc1">Box 1 (NDC or Drug Name):</label>
  <input type="text" id="ndc1" onkeypress="if(event.key === 'Enter') compareNDCs()" />

  <label for="ndc2">Box 2 (NDC optional):</label>
  <input type="text" id="ndc2" onkeypress="if(event.key === 'Enter') compareNDCs()" />

  <button onclick="compareNDCs()">Compare or Lookup</button>
  <button onclick="resetForm()">Reset</button>

  <h3>Result:</h3>
  <div id="result" class="result-section">Results will appear here...</div>

  <div class="disclaimer">
    <strong>Disclaimer:</strong> This tool is in <em>beta</em> and intended for informational purposes only.
    Data is sourced from public APIs and may not reflect the most current or complete information.
  </div>

<script>
  function formatNdc(ndc) {
    ndc = ndc.replace(/[^0-9]/g, '').padStart(11, '0');
    return ndc.slice(0, 5) + '-' + ndc.slice(5, 9) + '-' + ndc.slice(9);
  }

  async function getRxcuiFromNdc(ndc) {
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/ndcproperties.json?id=" + formatNdc(ndc));
    const json = await res.json();
    return json?.ndcPropertyList?.ndcProperty?.[0]?.rxcui || null;
  }

  async function getRxcuiCandidates(name) {
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term=" + encodeURIComponent(name));
    const json = await res.json();
    return json?.approximateGroup?.candidate?.map(c => c.rxcui) || [];
  }

  async function getFullName(rxcui) {
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/rxcui/" + rxcui + "/properties.json");
    const json = await res.json();
    return json?.properties?.name || "Unknown";
  }

  async function getNdcListFromRxcui(rxcui) {
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/rxcui/" + rxcui + "/ndcs.json");
    const json = await res.json();
    return json?.ndcGroup?.ndcList?.ndc || [];
  }

  async function getNdcStatuses(rxcui) {
    const res = await fetch("https://rxnav.nlm.nih.gov/REST/rxcui/" + rxcui + "/allProperties.json?prop=all");
    const json = await res.json();
    const ndcProps = json?.propConceptGroup?.propConcept || [];
    const statuses = {};
    ndcProps.forEach(p => {
      if (p.propCategory === 'NDC' && p.propName === 'NDC_STATUS') {
        statuses[p.propValue] = true;
      }
    });
    return statuses;
  }

  function lexicompLink(ndc) {
    return `https://online.lexi.com/lco/action/search?q=${ndc}&t=name`;
  }

  function resetForm() {
    document.getElementById("ndc1").value = "";
    document.getElementById("ndc2").value = "";
    document.getElementById("result").innerHTML = "Results will appear here...";
  }

  async function compareNDCs() {
    const input1 = document.getElementById("ndc1").value.trim();
    const input2 = document.getElementById("ndc2").value.trim();
    const output = document.getElementById("result");
    output.innerHTML = "Loading...";

    if (!input1 && !input2) {
      output.innerHTML = "Please enter a value in Box 1.";
      return;
    }

    try {
      if (input1 && !input2) {
        let rxcuis = [];
        let rxcuiFromNdc = await getRxcuiFromNdc(input1);

        if (rxcuiFromNdc) {
          rxcuis = [rxcuiFromNdc];
        } else {
          rxcuis = await getRxcuiCandidates(input1);
        }

        if (!rxcuis.length) {
          output.innerHTML = "No RxCUI found for input.";
          return;
        }

        let uniqueRxcuis = [...new Set(rxcuis)];
        let resultHTML = "";
        for (let rxcui of uniqueRxcuis) {
          const [name, ndcs, statuses] = await Promise.all([
            getFullName(rxcui),
            getNdcListFromRxcui(rxcui),
            getNdcStatuses(rxcui)
          ]);

          if (name === "Unknown") continue;

          resultHTML += `<b>${name}</b> ‚Äî RxCUI: <a href='https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${rxcui}' target='_blank'>${rxcui}</a><br>`;
          if (ndcs.length) {
            resultHTML += `<div class='child-result'><table class='ndc-table'><tr><th>NDC</th><th>Status</th><th>Lexicomp</th></tr>`;
            ndcs.forEach(ndc => {
              const status = statuses[ndc] || "Unknown";
              resultHTML += `<tr><td>${ndc}</td><td>${status}</td><td><a href='${lexicompLink(ndc)}' target='_blank'>Lexicomp</a></td></tr>`;
            });
            resultHTML += `</table></div><br>`;
          }
        }
        output.innerHTML = resultHTML;
        return;
      }

      const [rxcui1, rxcui2] = await Promise.all([
        getRxcuiFromNdc(input1),
        getRxcuiFromNdc(input2)
      ]);

      if (!rxcui1 || !rxcui2) {
        output.innerHTML = "One or both NDCs not found.";
        return;
      }

      const match = rxcui1 === rxcui2;
      const status = match
        ? "‚úîÔ∏è <b>Equivalent RxCUI</b>"
        : "‚ö†Ô∏è <b>Different RxCUI</b> ‚Äî may still be clinically equivalent";

      output.innerHTML =
        `${status}<br><br>` +
        `NDC 1 RxCUI: <a href='https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${rxcui1}' target='_blank'>${rxcui1}</a> ‚Äî <a href='${lexicompLink(input1)}' target='_blank'>Lexicomp</a><br>` +
        `NDC 2 RxCUI: <a href='https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${rxcui2}' target='_blank'>${rxcui2}</a> ‚Äî <a href='${lexicompLink(input2)}' target='_blank'>Lexicomp</a><br>` +
        `<br>üîç <i>Note: Use clinical judgment. RxCUI mismatch doesn't guarantee clinical difference.</i>`;

    } catch (err) {
      output.innerHTML = "‚ö†Ô∏è Error: " + err.message;
    }
  }
</script>
</body>
</html>
